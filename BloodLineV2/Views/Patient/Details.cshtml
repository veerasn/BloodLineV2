<!DOCTYPE html>
@using BloodLineV2.Models
@using BloodLineV2.ViewModels
@model IEnumerable<BloodLineV2.ViewModels.PatientDetailViewModel>

@{
    ViewBag.Title = "Details";
}

<html>
<head>
    <title>UMMC Blood Transfusion Information System</title>
    <script src="https://kit.fontawesome.com/4576929075.js" crossorigin="anonymous"></script>
    <style>
        html, body, h1, h2, h3, h4, h5 {
            font-family: "Raleway", sans-serif
        }
    </style>
    <link href="~/Content/tagsinput.css" rel="stylesheet"/>

    <script src="~/Scripts/jquery-3.4.1.js"></script>
    <script type="text/html" src="~/Scripts/chart-2.7.1.min.js"></script>
    <script src="~/Scripts/Chart.js"></script>
    <script src="~/Scripts/bootstrap-datetimepicker.min.js"></script>
    <script type="text/javascript" src="~/Scripts/moment.min.js"></script>
    <script src="~/Scripts/jquery.unobtrusive-ajax.min.js"></script>
    <script scr="~/Scripts/chartjs-plugin-annotation.js"></script>
    <script src="~/Scripts/tagsinput.js"></script>
</head>

<body class="w3-light-grey">
    <!-- Top container -->
    <div class="w3-bar w3-black w3-large" style="z-index:4">
        <button class="w3-bar-item w3-button w3-hide-large w3-hover-none w3-hover-text-light-grey" onclick="w3_open();"><i class="fa fa-bars"></i>  Menu</button>
        <span class="w3-bar-item w3-right">UMMC Blood Transfusion Information System</span>
    </div>

    <!-- Sidebar/menu -->
    <nav class="w3-sidebar w3-collapse w3-white w3-animate-left" style="z-index:3;width:300px;" id="mySidebar">
        <br>
        <div class="w3-container w3-row">

        </div>
        <hr>
        <div class="w3-container">
            <h5>Make your choice</h5>
        </div>
        <div class="w3-bar-block">
            <a href="#" class="w3-bar-item w3-button w3-padding-16 w3-hide-large w3-dark-grey w3-hover-black" onclick="w3_close()" title="close menu"><i class="fa fa-remove fa-fw"></i>  Close Menu</a>
            <a href="#" class="w3-bar-item w3-button w3-padding w3-blue"><i class="	fa fa-laptop-medical"></i>  Review and request</a>
            <a href="#" class="w3-bar-item w3-button w3-padding"><i class="fa fa-vials"></i>  Obtain blood sample</a>
            <a href="#" class="w3-bar-item w3-button w3-padding"><i class="fa fa-procedures"></i>  Transfuse and monitor</a>
            <a href="#" class="w3-bar-item w3-button w3-padding"><i class="fa fa-allergies"></i>  Adverse event reporting</a>
        </div>
        <hr />
        <div class="w3-container">
            <i class="fa fa-id-card"></i>
            <h5>@Html.DisplayFor(model => model.FirstOrDefault().NAME)</h5>
            <h5>@Html.DisplayFor(model => model.FirstOrDefault().PATNUMBERSHORT)</h5>
            <h5>@Html.DisplayFor(model => model.FirstOrDefault().BIRTHDATE)</h5>
            <h5>@Html.DisplayFor(model => model.FirstOrDefault().SEXLONG)</h5>

            <button type="button" class="btn btn-primary w3-padding" data-toggle="modal" data-target="#cart">Request (<span class="total-count"></span>)</button>
            <button class="clear-cart btn btn-danger w3-padding">Cancel Request</button>

        </div>
    </nav>

    <!-- Overlay effect when opening sidebar on small screens -->
    <div class="w3-overlay w3-hide-large w3-animate-opacity" onclick="w3_close()" style="cursor:pointer" title="close side menu" id="myOverlay"></div>

    <!-- !PAGE CONTENT! -->
    <div class="w3-main" style="margin-left:300px;margin-top:43px;">
        <!--Patient Name Header-->
        <header class="w3-container" style="padding-top:22px">
            <h5>
                <b>
                    <i class="fa fa-heart"></i> @Html.DisplayFor(model => model.FirstOrDefault().NAME) |
                    RN: @Html.DisplayFor(model => model.FirstOrDefault().PATNUMBERSHORT) |
                    DOB: @Html.DisplayFor(model => model.FirstOrDefault().BIRTHDATE)  |
                    Sex: @Html.DisplayFor(model => model.FirstOrDefault().SEXLONG)
                </b>
            </h5>
        </header>
        <!--Patient Result Summary-->
        <div class="w3-row-padding w3-margin-bottom">
            <!--ABO and RhD results-->
            <div class="w3-third">
                <div class="w3-container w3-red w3-padding-16">
                    <div class="w3-left">
                        <div class="w3-clear"><h1><b>@Html.DisplayFor(model => model.FirstOrDefault().PATGROUP) </b></h1></div>
                    </div>
                    <div class="w3-right">
                        @if (ViewBag.RhErr > 0 || ViewBag.AboErr > 0)
                        {
                            <i class="fa fa-exclamation"></i>
                        }
                        else
                        {
                            if (ViewBag.Abonum == 1)
                            {
                                <i class="fa fa-bars"></i>
                            }
                            else if (ViewBag.Abonum > 1)
                            {
                                <i class="fa fa-check-double"></i>
                            }
                            else
                            {
                                <i class="fa fa-question"></i>
                            }
                        }
                    </div>
                </div>
            </div>
            <!--Antibody screening results-->
            <div class="w3-third">
                <div class="w3-container w3-blue w3-padding-16">
                    <div class="w3-left">
                        @if (ViewBag.Absnum > 0 || ViewBag.AbsErr > 0)
                        {
                            <div class="w3-clear"><h1><b>@Html.DisplayFor(model => model.FirstOrDefault().ABSHORT)</b></h1></div>
                        }
                        else
                        {
                            <div class="w3-clear"><h1><b>AB:NR</b></h1></div>
                        }
                    </div>
                    <div class="w3-right">
                        @if (ViewBag.Absnum > 0 && ViewBag.AbsErr == 0)
                        {
                            <i class="fa fa-user-shield"></i>
                        }
                        else if (ViewBag.AbsErr > 0)
                        {
                            <i class="fa fa-exclamation"></i>
                        }
                        else
                        {
                            <i class="fa fa-question"></i>
                        }
                    </div>
                </div>
            </div>
            <!--Electronic issue-->
            <div class="w3-third">
                <div class="w3-container w3-teal w3-padding-16">
                    <div class="w3-left">
                        <div class="w3-clear"><h1><b>@Html.DisplayFor(model => model.FirstOrDefault().EI)</b></h1></div>
                    </div>
                </div>
            </div>
            <!--Notifications and alerts-->
            <div class="w3-container w3-light-gray">
                <p><b>Current status of patient and ongoing testing</b></p>
                <div>
                    @if (ViewBag.RhErr > 0 || ViewBag.AboErr > 0)
                    {
                        <p>Discrepancy in blood grouping identified. Please contact the transfusion laboratory if clarification required.</p>
                    }
                    else
                    {
                        if (ViewBag.Abonum > 1 && Model.FirstOrDefault().PATGROUP != null)
                        {
                            <p>Blood group confirmed based on two or more determinations.</p>
                        }
                        else if (ViewBag.Abonum == 1 && Model.FirstOrDefault().PATGROUP != null)
                        {
                            <p>Blood group based on single determination. Please submit second sample for confirmation.</p>
                        }
                        else
                        {
                            <p>No valid blood group records available.</p>
                        }
                    }
                </div>
                <div>
                    @if (ViewBag.ReqValid > 0)
                    {
                        <i class="fa fa-vial"></i>
                        <i class="fa fa-check"></i>
                        <sup>@ViewBag.ReqValidDate</sup>
                    }

                    @if (ViewBag.InReserve > 0)
                    {
                        <i class="fa fa-first-aid"></i>
                        <sup>@ViewBag.InReserve</sup>
                    }
                    @ViewBag.IssueIntNow
                </div>
            </div>
        </div>
        <!--LMD Results and charts-->
        <!--Render charts for Hgb, Plt, INR and APT-->
        <div class="w3-container">
            @if (ViewBag.iHgb > 0)
            {
                <div class="w3-quarter">
                    <canvas id="bar-chart-hgb" width="50" height="50"></canvas>
                </div>
            }
            @if (ViewBag.iPlt > 0)
            {
                <div class="w3-quarter">
                    <canvas id="bar-chart-plt" width="50" height="50"></canvas>
                </div>
            }
            @if (ViewBag.iInr > 0)
            {
                <div class="w3-quarter">
                    <canvas id="bar-chart-inr" width="50" height="50"></canvas>
                </div>
            }
            @if (ViewBag.iApt > 0)
            {
                <div class="w3-quarter">
                    <canvas id="bar-chart-apt" width="50" height="50"></canvas>
                </div>
            }
        </div>
        <!--Hb chart-->
        @if (ViewBag.iHgb > 0)
        {
            <script type="text/javascript">
                var hgb_x = @Html.Raw(Json.Encode(ViewBag.xHb))
                var hgb_y = @Html.Raw(Json.Encode(ViewBag.yHb))
                var mcv_y = @Html.Raw(Json.Encode(ViewBag.yMcv))

                new Chart(document.getElementById("bar-chart-hgb"), {
                    type: 'bar',
                    data: {
                        labels: hgb_x,
                        datasets: [
                            {
                                label: "Hgb (g/L)",
                                backgroundColor: "#ff6666",
                                data: hgb_y
                            },
                            {
                                label: "MCV (fl)",
                                borderColor: "#cc0000",
                                data: mcv_y,
                                type: "line"
                            }
                        ]
                    },
                    options: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: "Haemoglobin (g/L)"
                        },
                        scales: {
                            xAxes: [{
                                display: true,
                                scaleLabel: {
                                    display: true,
                                    labelString: 'Interval (days)'
                                }

                            }],
                            yAxes: [{
                                display: true,
                                ticks: {
                                    beginAtZero: true,
                                    steps: 10,
                                    stepValue: 5,
                                    max:150
                                }
                            }],
                        },
                        annotation: {
                            annotations: [{
                                type: 'line',
                                mode: 'horizontal',
                                scaleID: 'y-axis-0',
                                value: 80,
                                borderColor: 'rgb(255,51,51)',
                                borderWidth: 4,
                                label: {
                                    enabled: false,
                                    content: 'Max limit'
                                }
                            }]
                        }
                    }
                });
            </script>
        }
        <!--Plt chart-->
        @if (ViewBag.iPlt > 0)
        {
            <script tyep="text/javascript">
                var plt_x = @Html.Raw(Json.Encode(ViewBag.xPlt))
                var plt_y = @Html.Raw(Json.Encode(ViewBag.yPlt))

                new Chart(document.getElementById("bar-chart-plt"), {
                    type: 'bar',
                    data: {
                        labels: plt_x,
                        datasets: [
                            {
                                label: "Platelet (x 10^9/L)",
                                backgroundColor: "#ffb266",
                                data: plt_y
                            }
                        ]
                    },
                    options: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: "Platelet (x 10^9/L)"
                        },
                        scales: {
                            xAxes: [{
                                display: true,
                                scaleLabel: {
                                    display: true,
                                    labelString: 'Interval (days)'
                                }

                            }],
                            yAxes: [{
                                display: true,
                                ticks: {
                                    beginAtZero: true,
                                    steps: 50,
                                    stepValue: 10,
                                    max:400
                                }
                            }],
                        },
                        annotation: {
                            annotations: [{
                                type: 'line',
                                mode: 'horizontal',
                                scaleID: 'y-axis-0',
                                value: 20,
                                borderColor: 'rgb(255,128,0)',
                                borderWidth: 4,
                                label: {
                                    enabled: false,
                                    content: 'Max limit'
                                }
                            }]
                        }
                    }
                });
            </script>
        }
        <!--INR chart-->
        @if (ViewBag.iInr > 0)
        {
            <script tyep="text/javascript">
                var inr_x = @Html.Raw(Json.Encode(ViewBag.xInr))
                var inr_y = @Html.Raw(Json.Encode(ViewBag.yInr))

                new Chart(document.getElementById("bar-chart-inr"), {
                    type: 'bar',
                    data: {
                        labels: inr_x,
                        datasets: [
                            {
                                label: "INR",
                                backgroundColor: "#66b2ff",
                                data: inr_y
                            }
                        ]
                    },
                    options: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: "INR"
                        },
                        scales: {
                            xAxes: [{
                                display: true,
                                scaleLabel: {
                                    display: true,
                                    labelString: 'Interval (days)'
                                }

                            }],
                            yAxes: [{
                                display: true,
                                ticks: {
                                    beginAtZero: true,
                                    steps: 1,
                                    stepValue: 0.5,
                                    max:6
                                }
                            }],
                        },
                        annotation: {
                            annotations: [{
                                type: 'line',
                                mode: 'horizontal',
                                scaleID: 'y-axis-0',
                                value: 1,
                                borderColor: 'rgb(0,128,255)',
                                borderWidth: 4,
                                label: {
                                    enabled: false,
                                    content: 'Max limit'
                                }
                            }]
                        }
                    }
                });
            </script>
        }
        <!--APT chart-->
        @if (ViewBag.iApt > 0)
        {
            <script tyep="text/javascript">
                var apt_x = @Html.Raw(Json.Encode(ViewBag.xApt))
                var apt_y = @Html.Raw(Json.Encode(ViewBag.yApt))

                new Chart(document.getElementById("bar-chart-apt"), {
                    type: 'bar',
                    data: {
                        labels: apt_x,
                        datasets: [
                            {
                                label: "APTT (sec)",
                                backgroundColor: "#cc0066",
                                data: apt_y
                            }
                        ]
                    },
                    options: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: "APTT (sec)"
                        },
                        scales: {
                            xAxes: [{
                                display: true,
                                scaleLabel: {
                                    display: true,
                                    labelString: 'Interval (days)'
                                }

                            }],
                            yAxes: [{
                                display: true,
                                ticks: {
                                    beginAtZero: true,
                                    steps: 10,
                                    stepValue: 5,
                                    max:60
                                }
                            }],
                        },
                        annotation: {
                            annotations: [{
                                type: 'line',
                                mode: 'horizontal',
                                scaleID: 'y-axis-0',
                                value: 34,
                                borderColor: 'rgb(0,0,255)',
                                borderWidth: 4,
                                label: {
                                    enabled: false,
                                    content: 'Max limit'
                                }
                            }]
                        }
                    }
                });
            </script>
        }
        <!-- Review results and transfusions -->
        <div class="w3-container">
            <div class="panel-group" id="accordion-review">
                <!-- Requests and results -->
                <div class="w3-panel w3-gray panel-default">
                    <div class="panel-heading">
                        <h5 class="panel-title">
                            <a data-toggle="collapse" data-parent="#accordion-review" href="#collapse1">Requests and results</a>
                            <span class="badge badge-pill badge-primary">@ViewBag.TestCount</span>
                        </h5>
                    </div>
                    <div id="collapse1" class="panel-collapse collapse">
                        <div class="panel-body w3-light-gray">
                            @if (ViewBag.TestCount > 0)
                            {
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Date </th>
                                            <th></th>
                                            <th>ABO</th>
                                            <th>Rh</th>
                                            <th>DAT</th>
                                            <th>Ab screen</th>
                                            <th>Ab ID</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @{var res = ViewData["TestResults"] as string[,];
                                            for (int row = 0; row < res.GetLength(0); row++)
                                            {
                                                <tr>
                                                    @for (int column = 0; column < res.GetLength(1); column++)
                                                    {
                                                        switch (column)
                                                        {
                                                            case 2:
                                                                if (res[row, column] != null)
                                                                {
                                                                    <td><i class="fa fa-vial"></i><sup>@res[row, column]</sup></td>
                                                                }
                                                                else
                                                                {
                                                                    <td>@res[row, column]</td>
                                                                };
                                                                break;

                                                            case 6:
                                                                if (res[row, column] != null && res[row, column].Contains("POS"))
                                                                {
                                                                    <td><b><font color="red">@res[row, column]</font></b></td>
                                                                }
                                                                else
                                                                {
                                                                    <td>@res[row, column]</td>
                                                                };
                                                                break;

                                                            case 7:
                                                                if (res[row, column] != null)
                                                                {
                                                                    <td><i class="fa fa-exclamation"></i></td>
                                                                }
                                                                else
                                                                {
                                                                    <td>@res[row, column]</td>
                                                                };
                                                                break;

                                                            default:
                                                                <td>@res[row, column]</td>
                                                                break;
                                                        }
                                                    }
                                                </tr>
                                            }
                                        }
                                    </tbody>
                                </table>
                            }
                        </div>
                    </div>
                </div>
                <!-- Red Cells -->
                <div class="w3-panel w3-gray panel-default">
                    <div class="panel-heading">
                        <h5 class="panel-title">
                            <a data-toggle="collapse" data-parent="#accordion-review" href="#collapse2">Red blood cells</a>
                            <span class="badge badge-pill badge-primary">@ViewBag.Rccount</span>
                            @if (ViewBag.Rccount > 0)
                            {
                                <i class="fa fa-vial"></i> @ViewBag.Reserved
                                <i class="fa fa-clipboard-check"></i> @ViewBag.Issued
                                <i class="fa fa-procedures"></i> @ViewBag.Transfused
                                <i class="fa fa-tag"></i> @ViewBag.Returned
                                <i class="fa fa-allergies"></i> @ViewBag.Reaction
                            }
                        </h5>
                    </div>
                    <div id="collapse2" class="panel-collapse collapse">
                        <div class="panel-body w3-light-gray">
                            @if (ViewBag.Rccount > 0)
                            {
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Request Time & Date</th>
                                            <th>Type</th>
                                            <th>Pack ID</th>
                                            <th>History</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in Model)
                                        {
                                            if (item.PRODNUM != null && item.PRODCODE.Substring(0, 2) == "RC")
                                            {
                                                <tr>
                                                    <td>@item.ACCESSNUMBER</td>
                                                    <td>@Html.DisplayFor(modelItem => item.REQDATE)</td>
                                                    <td>@item.PRODCODE</td>
                                                    <td>@item.PRODNUM</td>
                                                    <td>
                                                        @if (item.RESERVDATE != null && item.ReservIntDay < 8)
                                                        {
                                                            <i class="fa fa-file-prescription"></i>
                                                            <sup>@item.RESERVDATE.Value.ToString("HH:mm") d:@item.ReservIntDay</sup>
                                                        }
                                                        @if (item.XMATCHDATE != null && item.XmatchIntDay < 8)
                                                        {
                                                            <i class="fa fa-vials"></i>
                                                            <sup>@item.XMATCHDATE.Value.ToString("HH:mm") d:@item.XmatchIntDay</sup>
                                                        }
                                                        @if (item.ISSUEDATE != null && item.IssueIntDay < 8)
                                                        {
                                                            <i class="fa fa-clipboard-check"></i>
                                                            <sup>@item.ISSUEDATE.Value.ToString("HH:mm") d:@item.IssueIntDay</sup>
                                                        }
                                                        @if (item.RETURNDATE != null && item.ReturnIntDay < 8)
                                                        {
                                                            <i class="fa fa-tag"></i>
                                                            <sup>@item.RETURNDATE.Value.ToString("HH:mm") d:@item.ReturnIntDay</sup>
                                                        }
                                                    </td>
                                                    <td>
                                                        @if (item.TRANSREACTION != null)
                                                        {
                                                            <i class="fa fa-allergies"></i>
                                                        }
                                                    </td>
                                                </tr>
                                            }
                                        }
                                    </tbody>
                                </table>
                            }
                        </div>
                    </div>
                </div>
                <!-- Platelets -->
                <div class="w3-panel w3-gray panel-default">
                    <div class="panel-heading">
                        <h5 class="panel-title">
                            <a data-toggle="collapse" data-parent="#accordion-review" href="#collapse3">Platelets</a>
                            <span class="badge badge-pill badge-primary">@ViewBag.Plcount</span>
                            @if (ViewBag.Plcount > 0)
                            {
                                <i class="fa fa-clipboard-check"></i> @ViewBag.PlIssued
                                <i class="fa fa-procedures"></i> @ViewBag.PlTransfused
                                <i class="fa fa-tag"></i> @ViewBag.PlReturned
                                <i class="fa fa-allergies"></i> @ViewBag.Reaction
                            }
                        </h5>
                    </div>
                    <div id="collapse3" class="panel-collapse collapse">
                        <div class="panel-body w3-light-gray">
                            @if (ViewBag.Plcount > 0)
                            {
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Request Time & Date</th>
                                            <th>Type</th>
                                            <th>Pack ID</th>
                                            <th>History</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in Model)
                                        {
                                            if (item.PRODNUM != null && item.PRODCODE.Substring(0, 2) == "PL")
                                            {
                                                <tr>
                                                    <td>@item.ACCESSNUMBER</td>
                                                    <td>@Html.DisplayFor(modelItem => item.REQDATE)</td>
                                                    <td>@item.PRODCODE</td>
                                                    <td>@item.PRODNUM</td>
                                                    <td>
                                                        @if (item.RESERVDATE != null && item.ReservIntDay < 8)
                                                        {
                                                            <i class="fa fa-file-prescription"></i>
                                                            <sup>@item.RESERVDATE.Value.ToString("HH:mm") d:@item.ReservIntDay</sup>
                                                        }
                                                        @if (item.XMATCHDATE != null && item.XmatchIntDay < 8)
                                                        {
                                                            <i class="fa fa-vials"></i>
                                                            <sup>@item.XMATCHDATE.Value.ToString("HH:mm") d:@item.XmatchIntDay</sup>
                                                        }
                                                        @if (item.ISSUEDATE != null && item.IssueIntDay < 8)
                                                        {
                                                            <i class="fa fa-clipboard-check"></i>
                                                            <sup>@item.ISSUEDATE.Value.ToString("HH:mm") d:@item.IssueIntDay</sup>
                                                        }
                                                        @if (item.RETURNDATE != null && item.ReturnIntDay < 8)
                                                        {
                                                            <i class="fa fa-tag"></i>
                                                            <sup>@item.RETURNDATE.Value.ToString("HH:mm") d:@item.ReturnIntDay</sup>
                                                        }
                                                    </td>
                                                    <td>
                                                        @if (item.TRANSREACTION != null)
                                                        {
                                                            <i class="fa fa-allergies"></i>
                                                        }
                                                    </td>
                                                </tr>
                                            }
                                        }
                                    </tbody>
                                </table>
                            }
                        </div>
                    </div>
                </div>
                <!-- Plasma products -->
                <div class="w3-panel w3-gray panel-default">
                    <div class="panel-heading">
                        <h5 class="panel-title">
                            <a data-toggle="collapse" data-parent="#accordion-review" href="#collapse4">Plasma products</a>
                            <span class="badge badge-pill badge-primary">@ViewBag.Fpcount</span>
                            @if (ViewBag.Fpcount > 0)
                            {
                                <i class="fa fa-clipboard-check"></i> @ViewBag.FpIssued
                                <i class="fa fa-procedures"></i> @ViewBag.FpTransfused
                                <i class="fa fa-tag"></i> @ViewBag.FpReturned
                                <i class="fa fa-allergies"></i> @ViewBag.Reaction
                            }
                        </h5>
                    </div>
                    <div id="collapse4" class="panel-collapse collapse">
                        <div class="panel-body w3-light-gray">
                            @if (ViewBag.Fpcount > 0)
                            {
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Request Time & Date</th>
                                            <th>Type</th>
                                            <th>Pack ID</th>
                                            <th>History</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in Model)
                                        {
                                            if (item.PRODNUM != null && (item.PRODCODE.Substring(0, 2) == "FF" || item.PRODCODE.Substring(0, 2) == "CR"))
                                            {
                                                <tr>
                                                    <td>@item.ACCESSNUMBER</td>
                                                    <td>@Html.DisplayFor(modelItem => item.REQDATE)</td>
                                                    <td>@item.PRODCODE</td>
                                                    <td>@item.PRODNUM</td>
                                                    <td>
                                                        @if (item.RESERVDATE != null && item.ReservIntDay < 8)
                                                        {
                                                            <i class="fa fa-file-prescription"></i>
                                                            <sup>@item.RESERVDATE.Value.ToString("HH:mm") d:@item.ReservIntDay</sup>
                                                        }
                                                        @if (item.XMATCHDATE != null && item.XmatchIntDay < 8)
                                                        {
                                                            <i class="fa fa-vials"></i>
                                                            <sup>@item.XMATCHDATE.Value.ToString("HH:mm") d:@item.XmatchIntDay</sup>
                                                        }
                                                        @if (item.ISSUEDATE != null && item.IssueIntDay < 8)
                                                        {
                                                            <i class="fa fa-clipboard-check"></i>
                                                            <sup>@item.ISSUEDATE.Value.ToString("HH:mm") d:@item.IssueIntDay</sup>
                                                        }
                                                        @if (item.RETURNDATE != null && item.ReturnIntDay < 8)
                                                        {
                                                            <<i class="fa fa-tag"></i>
                                                            <sup>@item.RETURNDATE.Value.ToString("HH:mm") d:@item.ReturnIntDay</sup>
                                                        }
                                                    </td>
                                                    <td>
                                                        @if (item.TRANSREACTION != null)
                                                        {
                                                            <i class="fa fa-allergies"></i>
                                                        }
                                                    </td>
                                                </tr>
                                            }
                                        }
                                    </tbody>
                                </table>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!--Enter when products required and procedure type-->

        <div class="w3-panel w3-pale-blue">
            <!--Clinical indication-->
            <div class="card-header" id="headingTwo">
                <button class="btn btn-outline-info " data-toggle="collapse" data-target="#disorderType" aria-expanded="true" aria-controls="disorderType">
                    Relevent diagnoses?
                    <span class="badge badge-primary" id="badge-disorder"></span>
                </button>
                <div id="disorderType" class="collapse">
                    <div class="card-body">
                        <ul class=list-group list-group-flush" id="sct2-selected-disorders" style="list-style: none"></ul>
                    </div>
                    <input type="text" class="form-control" width="100" id="sct2-disorder" aria-label="Autocomplete using search text item" />
                    <div><ul id="sct2-disorder-values" style="list-style: none"></ul></div>
                </div>
            </div>
            <!--When required-->
            <div class="card-header" id="headingOne">
                <h5 class="mb-0">
                    <button class="btn btn-outline-info " data-toggle="collapse" data-target="#requiredTime" aria-expanded="true" aria-controls="requiredTime">
                        When are the products required?
                        <span class="badge badge-primary" id="badge-required-datetime"></span>
                    </button>

                </h5>
            </div>
            <div id="requiredTime" class="collapse">
                <div class="w3-row-padding w3-margin-bottom" id="request-timing">
                    <div class="w3-quarter w3-blue-grey">
                        <div class="w3-container w3-hover-text-light-gray w3-padding-2">
                            <div class="radio">
                                <label><input type="radio" name="optUrgency" onchange="updateRequiredDate(10)">Immediate</label>
                            </div>
                            <div class="radio">
                                <label><input type="radio" name="optUrgency" onchange="updateRequiredDate(30)">Urgent</label>
                            </div>
                            <div class="radio">
                                <label><input type="radio" name="optUrgency" checked onchange="updateRequiredDate(180)">Scheduled</label>
                            </div>
                        </div>
                    </div>
                    <div class="w3-quarter w3-blue-grey">
                        <div class="w3-container w3-hover-text-light-gray w3-padding-2">
                            <div class="radio">
                                <label><input type="radio" name="optDay" value="1" onchange="updateRequiredDate(180)">Today</label>
                            </div>
                            <div class="radio">
                                <label><input type="radio" name="optDay" value="2" onchange="updateRequiredDate(1440)">Tomorrow</label>
                            </div>
                            <div class="radio">
                                <label><input type="radio" name="optDay" value="3" onchange="updateRequiredDate(2880)">Day after</label>
                            </div>
                        </div>
                    </div>
                    <div class="w3-quarter w3-blue-grey">
                        <div class="w3-container w3-hover-text-light-gray w3-padding-2">
                            <div class="radio">
                                <label><input type="radio" name="optTime" value="1" onchange="updateRequiredTime('08:00')">Morning</label>
                            </div>
                            <div class="radio">
                                <label><input type="radio" name="optTime" value="2" onchange="updateRequiredTime('12:00')">Afternoon</label>
                            </div>
                            <div class="radio">
                                <label><input type="radio" name="optTime" value="3" onchange="updateRequiredTime('18:00')">Evening</label>
                            </div>
                        </div>
                    </div>
                    <div class="w3-quarter">
                        <div class="w3-container w3-light-blue w3-padding-small">
                            @Html.TextBoxFor(model => model.First().RequiredDate, new { id = "RequiredDate", @onchange = "refreshTimeBadge();", @type = "date", @class = "form-control datepicker", @Value = Model.First().RequiredDate.ToString("dd-mm-yyyy") })
                            @Html.TextBoxFor(model => model.First().RequiredTime, new { id = "RequiredTime", @onchange = "refreshTimeBadge();", @type = "time", @class = "form-control datepicker", @Value = Model.First().RequiredTime.ToString("hh:mm") })
                        </div>
                    </div>
                </div>
            </div>
            <!--Procedure-->
            <div class="card-header" id="headingTwo">
                <button class="btn btn-outline-info " data-toggle="collapse" data-target="#procedureType" aria-expanded="true" aria-controls="procedureType">
                    What procedure is the blood required for?
                    <span class="badge badge-primary" id="badge-procedure"></span>
                </button>
                <div id="procedureType" class="collapse">
                    <div class="card-body">
                        <ul class=list-group list-group-flush" id="sct2-selected-values" style="list-style: none"></ul>
                    </div>
                    <input type="text" class="form-control" width="100" id="sct2" aria-label="Autocomplete using search text item" />
                    <div><ul id="sct2-values" style="list-style: none"></ul></div>
                </div>
            </div>
        </div>

        <!--Tabs for selection of requests and products-->
        <div class="w3-container">
            <div class="w3-row">
                <a href="javacript:void(0)" onclick="openRequest(event, 'Test');">
                    <div class="w3-quarter tablink w3-bottombar w3-hover-grey w3-padding">Tests</div>
                </a>
                <a href="javacript:void(0)" onclick="openRequest(event, 'Rbc');">
                    <div class="w3-quarter tablink w3-bottombar w3-hover-grey w3-padding">Red Cells</div>
                </a>
                <a href="javacript:void(0)" onclick="openRequest(event, 'Platelet');">
                    <div class="w3-quarter tablink w3-bottombar w3-hover-grey w3-padding">Platelets</div>
                </a>
                <a href="javacript:void(0)" onclick="openRequest(event, 'Plasma');">
                    <div class="w3-quarter tablink w3-bottombar w3-hover-grey w3-padding">Plasma Products</div>
                </a>
                <!--Test requests-->
                <div id="Test" class="w3-container request" style="display:none">
                    <h6>Choose tests that your patient may require. </h6>
                    <div class="products">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>Code</th>
                                    <th></th>
                                    <th>Test Name</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (ProductInfo bloodProduct in ViewBag.ProductInfo)
                                {
                                    if (bloodProduct.Id.Substring(0, 2).Contains("T-") &&
                                        (Model.FirstOrDefault().AGE >= bloodProduct.Lowerage && Model.FirstOrDefault().AGE <= bloodProduct.Upperage))
                                    {
                                        <tr>
                                            <td>
                                                <a href="#0" class="button add-to-cart" data-name='@bloodProduct.Name' data-price=@bloodProduct.Charge data-id=@bloodProduct.Id data-parameter='@bloodProduct.Parameter'>Request</a>
                                            </td>
                                            <td>
                                                @bloodProduct.Id
                                            </td>
                                            <td>
                                                <a href="#0" class="button btn-info" data-toggle="modal" data-target="#product-info" onclick="productInfo('@bloodProduct.Id')">Info</a>
                                            </td>
                                            <td>
                                                @bloodProduct.Name
                                                @if (bloodProduct.Filelocation != "none")
                                                {
                                                    <a href="@bloodProduct.Filelocation" target="_blank">
                                                        <sup><i class="fa fa-info"></i></sup>
                                                    </a>
                                                }
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
                <!--Red cell requests-->
                <div id="Rbc" class="w3-container request" style="display:none">
                    <h6>
                        Select suitable products and required quantity. Remember that the minimum number of RBC units should be transfused to
                        achieve the desired response. Refer to <a href="~/Content/pdf/RBC_recommendation.pdf" target="_blank"><b>Guidelines for Red Cell Use</b></a> to aid your transfusion decision.
                    </h6>
                    <p id="alert_redcell" style="color: orangered"></p>
                    <p id="redcell" style="color: orangered"></p>
                    <p id="notice_hb" style="color: red">@ViewBag.cHgb</p>
                    <p id="notice_mcv" style="color: red">@ViewBag.cMcv</p>
                    <div class="products">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>Code</th>
                                    <th></th>
                                    <th>Product Name</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (ProductInfo bloodProduct in ViewBag.ProductInfo)
                                {
                                    if (bloodProduct.Id.Substring(0, 2).Contains("RC") &&
                                        (Model.FirstOrDefault().AGE >= bloodProduct.Lowerage && Model.FirstOrDefault().AGE <= bloodProduct.Upperage))
                                    {
                                        <tr>
                                            <td>
                                                <a href="#0" class="button add-to-cart" data-toggle="modal" data-target="#pick-indication" onclick="updateIndication('@bloodProduct.Parameter')" data-name='@bloodProduct.Name' data-price=@bloodProduct.Charge data-id=@bloodProduct.Id data-parameter='@bloodProduct.Parameter'>Request</a>
                                            </td>
                                            <td>
                                                @bloodProduct.Id
                                            </td>
                                            <td>
                                                <a href="#0" class="button btn-info" data-toggle="modal" data-target="#product-info" onclick="productInfo('@bloodProduct.Id')">Info</a>
                                            </td>
                                            <td>
                                                @bloodProduct.Name
                                                @if (bloodProduct.Filelocation != "none")
                                                {
                                                    <a href="@bloodProduct.Filelocation" target="_blank">
                                                        <sup><i class="fa fa-info"></i></sup>
                                                    </a>
                                                }
                                                @if (bloodProduct.Irradiate == 1)
                                                {
                                                    <i class="fa fa-radiation"></i>
                                                }
                                                @if (bloodProduct.Leucodeplete == 1)
                                                {
                                                    <i class="fa fa-filter"></i>
                                                }
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
                <!--End of Red cell requests-->
                <!--Platelet requests-->
                <div id="Platelet" class="w3-container request" style="display:none">
                    <h6>
                        Select suitable products and required quantity. Refer to <a href="~/Content/pdf/PLT_recommendation.pdf" target="_blank"><b>Guidelines for Platelet Use</b></a> to aid your transfusion decision.
                    </h6>
                    <p id="alert_platelet" style="color: orangered"></p>
                    <p id="platelet" style="color: orangered"></p>
                    <p id="notice_platelet" style="color: red">@ViewBag.cPlt</p>
                    <div class="products">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>Code</th>
                                    <th></th>
                                    <th>Product Name</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (ProductInfo bloodProduct in ViewBag.ProductInfo)
                                {
                                    if (bloodProduct.Id.Substring(0, 2).Contains("PL") &&
                                        (Model.FirstOrDefault().AGE >= bloodProduct.Lowerage && Model.FirstOrDefault().AGE <= bloodProduct.Upperage))
                                    {
                                        <tr>
                                            <td>
                                                <a href="#0" class="button add-to-cart" data-toggle="modal" data-target="#pick-indication" onclick="updateIndication('@bloodProduct.Parameter')" data-name='@bloodProduct.Name' data-price=@bloodProduct.Charge data-id=@bloodProduct.Id data-parameter='@bloodProduct.Parameter'>Request</a>
                                            </td>
                                            <td>
                                                @bloodProduct.Id
                                            </td>
                                            <td>
                                                <a href="#0" class="button btn-info" data-toggle="modal" data-target="#product-info" onclick="productInfo('@bloodProduct.Id')">Info</a>
                                            </td>
                                            <td>
                                                @bloodProduct.Name
                                                @if (bloodProduct.Filelocation != "none")
                                                {
                                                    <a href="@bloodProduct.Filelocation" target="_blank">
                                                        <sup><i class="fa fa-info"></i></sup>
                                                    </a>
                                                }
                                                @if (bloodProduct.Irradiate == 1)
                                                {
                                                    <i class="fa fa-radiation"></i>
                                                }
                                                @if (bloodProduct.Leucodeplete == 1)
                                                {
                                                    <i class="fa fa-filter"></i>
                                                }
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
                <!--Plasma products and derivatives requests-->
                <div id="Plasma" class="w3-container request" style="display:none">
                    <h6>
                        Select suitable products and required quantity. Refer to <a href="#"><b>Guidelines for FFP Transfusions</b></a> to aid your transfusion decision.
                    </h6>
                    <p id="alert_ffp" style="color: orangered"></p>
                    <p id="alert_cryoprecipitate" style="color: orangered"></p>
                    <p id="ffp" style="color: orangered"></p>
                    <p id="cryoprecipitate" style="color: orangered"></p>
                    <p id="notice_ffp" style="color: red">@ViewBag.cInr</p>
                    <div class="products">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>Code</th>
                                    <th></th>
                                    <th>Product Name</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (ProductInfo bloodProduct in ViewBag.ProductInfo)
                                {
                                    if (bloodProduct.Id.Substring(0, 2).Contains("PP") &&
                                        (Model.FirstOrDefault().AGE >= bloodProduct.Lowerage && Model.FirstOrDefault().AGE <= bloodProduct.Upperage))
                                    {
                                        <tr>
                                            <td>
                                                <a href="#0" class="button add-to-cart" data-toggle="modal" data-target="#pick-indication"
                                                   onclick="updateIndication('@bloodProduct.Parameter')" data-name='@bloodProduct.Name' data-price=@bloodProduct.Charge data-id=@bloodProduct.Id data-parameter='@bloodProduct.Parameter'>Request</a>
                                            </td>
                                            <td>
                                                @bloodProduct.Id
                                            </td>
                                            <td>
                                                <a href="#0" class="button btn-info" data-toggle="modal" data-target="#product-info" onclick="productInfo('@bloodProduct.Id')">Info</a>
                                            </td>
                                            <td>
                                                @bloodProduct.Name
                                                @if (bloodProduct.Filelocation != "none")
                                                {
                                                    <a href="@bloodProduct.Filelocation" target="_blank">
                                                        <sup><i class="fa fa-info"></i></sup>
                                                    </a>
                                                }
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!--Modal form - Request-->
        <div class="modal fade" id="cart" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Requests</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <table id="tblConfirmRequest" class="table table-striped table-responsive text-wrap w-auto">
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th style="display:none">Parameter</th>
                                    <th>Description</th>
                                    <th>Charge</th>
                                    <th></th>
                                    <th>Units</th>
                                    <th></th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody class="show-cart">
                                <!--Inject rows from displayCart js-->
                            </tbody>
                        </table>
                        <div>Total estimate: RM<span class="total-cart"></span></div>
                        <!--Display all alerts-->
                        <div>
                            <ul class="list-group list-group-flush list-group-item-danger" id="modal-alert" style="list-style:none"></ul>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button onclick="confirmRequest()" type="button" class="btn btn-primary" id="confirm-request">Confirm request</button>
                    </div>
                    <div>
                        <ul class="list-group list-group-flush list-group-item-danger" id="warning-confirm-request" style="list-style:none"></ul>
                    </div>
                    <div>
                        <input class="btn-default" type="button" id="btnCartNew" value="Save" />
                        <input class="btn-default" type="button" id="btnAddItems" value="Save" />
                    </div>
                </div>
            </div>
        </div>

        <!--Modal form - Indication-->
        <div class="modal fade" id="pick-indication" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title" id="pick-indication-label">Clinical indication</h4>
                        <button type="button" class="close float-right" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">X</span></button>
                    </div>
                    <div class="modal-body">
                        <h6>Select the most important indication for this transfusion</h6>
                        <table class="table table-striped" id="list-indication-product">
                            <tbody>
                                <!--Insert table using updateIndication js function-->
                            </tbody>
                        </table>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="productIndication('redcell')">Save changes</button>
                    </div>
                </div>
            </div>
        </div>

        <!--Modal form - Product Info-->
        <div class="modal fade" id="product-info" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title" id="list-info-product-header">Product Code</h4>
                        <button type="button" class="close float-right" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">X</span></button>
                    </div>
                    <div class="modal-body">
                        <div id="list-info-product">
                            <!--Inject product information by productInfo js-->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!--Modal form - Select Procedure-->
        <div class="modal fade" id="select-procedure" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title" id="select-procedure-header">Procedure List (ICD10-PCS)</h4>
                        <button type="button" class="close float-right" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">X</span></button>
                    </div>
                    <div class="modal-body">
                        <label for="icd10-level3">Select procedure:</label>
                        <select name="icd10-level3" class="custom-select" id="icd10-level3"></select>
                        <label for="icd10-level4">Select procedure:</label>
                        <select name="icd10-level4" class=" custom-select" id="icd10-level4"></select>
                    </div>
                </div>
            </div>
        </div>
        <!--Terminating messages and alerts-->
        <br>
        <div class="w3-container w3-dark-grey w3-padding-32">
            <div class="w3-row">
                <div class="w3-container w3-third">
                    <h5 class="w3-bottombar w3-border-green">Messages & Alerts</h5>
                </div>
                <div class="w3-container w3-third">
                    <h5 class="w3-bottombar w3-border-red">Blood Stock Levels</h5>
                </div>
                <div class="w3-container w3-third">
                    <h5 class="w3-bottombar w3-border-orange">Guidelines</h5>
                </div>
            </div>
        </div>
        <!-- Footer -->
        <footer class="w3-container w3-padding-16 w3-light-grey">
            <h4>USE BLOOD WISELY</h4>
        </footer>
        <!-- End page content -->
    </div>
    <script>
        // Get the Sidebar
        var mySidebar = document.getElementById("mySidebar");

        // Get the DIV with overlay effect
        var overlayBg = document.getElementById("myOverlay");

        // Toggle between showing and hiding the sidebar, and add overlay effect
        function w3_open() {
            if (mySidebar.style.display === 'block') {
                mySidebar.style.display = 'none';
                overlayBg.style.display = "none";
            } else {
                mySidebar.style.display = 'block';
                overlayBg.style.display = "block";
            }
        }

        // Close the sidebar with the close button
        function w3_close() {
            mySidebar.style.display = "none";
            overlayBg.style.display = "none";
        }
    </script>
    <script>
        //Open and close request tabs
        function openRequest(evt, requestName) {
            var i, x, tablinks;
            x = document.getElementsByClassName("request");
            for (i = 0; i < x.length; i++) {
                x[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablink");
            for (i = 0; i < x.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" w3-border-red", "");
            }
            document.getElementById(requestName).style.display = "block";
            evt.currentTarget.firstElementChild.className += " w3-border-red";
        }
    </script>
    <script>
        $(document).ready(function () {
            $('#RequiredDate').datepicker();
            $('#RequiredTime').datepicker();
        });
    </script>
    <script>
        //Update badge with required date and time
        function refreshTimeBadge() {
            var d = document.getElementById("RequiredDate").value;
            var t = document.getElementById("RequiredTime").value;
            document.getElementById("badge-required-datetime").innerHTML = d + " " + t;
        }
    </script>
    <script>
        //Update RequiredTime according to optTime
        function updateRequiredTime(val) {
            document.getElementById("RequiredTime").value = val;
            refreshTimeBadge();
        }
    </script>
    <script>
        //Update RequiredDate according to optDay
        function updateRequiredDate(val) {
            var currentd = new Date();
            var d = new Date(currentd);
            d.setMinutes(d.getMinutes() + val);

            var dd = d.getDate();
            var mm = d.getMonth();
            var hh = d.getHours();
            var mn = d.getMinutes();

            var day;
            var month;
            var hour;
            var minute;
            var year;


            if (dd < 10) {
                day = '0' + dd;
            }
            else {
                day = dd;
            }
            if (mm + 1 < 10) {
                month = '0' + (mm + 1);
            }
            else {
                month = mm + 1;
            }
            if (hh < 10) {
                hour = '0' + hh;
            }
            else {
                hour = hh;
            }
            if (mn < 10) {
                minute = '0' + mn;
            }
            else {
                minute = mn;
            }

            year = d.getFullYear();

            var date = year + "-" + month + "-" + day;
            var time = hour + ":" + minute;
            document.getElementById("RequiredDate").value = date;
            document.getElementById("RequiredTime").value = time;
            refreshTimeBadge();
        }
    </script>
    <script>
        //Update dropdown boxes and modal forms for procedures
        $(function () {
            $("#icd10-level1").on("change", function () {
                updateIcd(this.value, 1);
            })

            $("#icd10-level2").on("change", function () {
                updateIcd(this.value, 2);
            })

            $("#icd10-level3").on("change", function () {
                updateIcd(this.value, 3);
            })
        });

        function updateIcd(icd10value, level) {
            var uri = "/Patient/GetProcedure";
            var selectValue;
            $.getJSON(uri, { icd10value: icd10value, level: level }).done(function (data) {
                //Update level 2 ICD10 category codes after updating level 1 category dropdown
                if (level == 1) {
                    selectValue = $('#icd10-level2');
                    selectValue.html("<option selected>Choose category</option>");
                    var count = 0;
                    $.each(data, function (key, item) {
                        var arr = item.split("|")
                        selectValue.append("<option value='" + arr[0] + "'>" + arr[1] + "</option>");
                        count++;
                    });
                }
                else if (level == 2) {
                    //open modal form for selection of procedure
                    selectValue = $('#icd10-level3');
                    selectValue.html("<option selected>Choose subcategory</option>");
                    var count = 0;
                    $.each(data, function (key, item) {
                        var arr = item.split("|")
                        selectValue.append("<option value='" + arr[0] + "'>" + arr[1] + "</option>");
                        count++;
                    });

                    $("#select-procedure").modal();

                }
                else if (level == 3) {
                    //open modal form for selection of procedure
                    selectValue = $('#icd10-level4');
                    selectValue.html("<option selected>Choose procedure</option>");
                    var count = 0;
                    $.each(data, function (key, item) {
                        var arr = item.split("|")
                        selectValue.append("<option value='" + arr[0] + "'>" + arr[1] + "</option>");
                        count++;
                    });

                    $("#select-procedure").modal();

                }
            });
        }
    </script>

    <!--Scripts for updating procedures/disorders-->
    <script>
        //Autofill procedure list using AJAX
        var textbox;
        //var selectValue;
        //var selectedValue;

        $(function () {
            textboxp = $("#sct2");
            textboxd = $("#sct2-disorder")

            //selectValuep = $('ul#sct2-values');
            //selectValued = $('ul#sct2-disorder-values');

            textboxp.on("input", function () {
                //Autocomplete only if a specific number of characters have been entered
                if (textboxp.val().length > 2) {
                    getAutoComplete(textboxp.val(), 'p');
                }
                else {
                    getAutoComplete('###', 'p');
                }
            });
            textboxd.on("input", function () {
                //Autocomplete only if a specific number of characters have been entered
                if (textboxd.val().length > 2) {
                    getAutoComplete(textboxd.val(), 'd');
                }
                else {
                    getAutoComplete('###', 'd');
                }
            });
        });

        function getAutoComplete(sct2value, type) {
            var selectValue;

            if (type == 'p') {
                var uri = "/Patient/GetProcedureSct2";
                selectValue = $('ul#sct2-values');
            }
            else if (type == 'd') {
                var uri = "/Patient/GetDisorderSct2";
                selectValue = $('ul#sct2-disorder-values');
            }

            $.getJSON(uri, { sct2value: sct2value }).done(function (data) {
                selectValue.html("");
                var count = 0;
                $.each(data, function (key, item) {
                    var arr = item.split("|")
                    var li = $('<li/>').addClass('ui-menu-item').attr('role', 'menu-item')
                        .html("<a href='#/' onclick=\"setText('" + arr[0] + " | " + arr[1] + "','" + type + "')\">" + arr[1] + "</a>")
                        .appendTo(selectValue);
                    count++;
                });
            });
        }
        function setText(text, type) {
            var selectedValue;
            if (type == 'p') {
                textboxp.val("");
                textboxp.focus();
                selectedValue = $('ul#sct2-selected-values');
            }
            else if (type == 'd') {
                textboxd.val("");
                textboxd.focus();
                selectedValue = $('ul#sct2-selected-disorders');
            }

            getAutoComplete("", type);

            selectedValue.append("<span><li class='list-group-item'><button class='btn btn-outline-info fa fa-trash'></button>" + "&nbsp" + text + "</li></span>");
            refreshProcedureBadge(type);
        }
    </script>
    <script>
        //Remove selected procedure
        $("ul#sct2-selected-values").on("click", "button", function (e) {
            e.preventDefault();
            $(this).parent().remove();
            refreshProcedureBadge('p');
        });
        $("ul#sct2-selected-disorders").on("click", "button", function (e) {
            e.preventDefault();
            $(this).parent().remove();
            refreshProcedureBadge('d');
        });
    </script>
    <script>
        //Update badge with procedure information
        function refreshProcedureBadge(type) {
            var lis;
            var target;

            if (type == 'p') {
                lis = document.getElementById("sct2-selected-values").getElementsByTagName("li");
                target = document.getElementById("badge-procedure");
            }
            else if (type == 'd') {
                var lis = document.getElementById("sct2-selected-disorders").getElementsByTagName("li");
                var target = document.getElementById("badge-disorder");
            }

            var i = lis.length;

            if (i > 0) {
                var str = lis[0].innerText;
                if (str.length > 60) {
                    str = str.substring(0, 50);
                }
                else {
                    str = str;
                }

                if (i == 1) {
                    target.innerHTML = str;
                }
                else if (i > 1) {
                    target.innerHTML = str + "..+" + (i - 1) + " more";
                }
                else {
                    target.innerHTML = "";
                }
            }
            else {
                target.innerHTML = "";
            }
        }
    </script>
    <!--End of scripts for updating procedures-->
    <script>
        //Update table for indication specific to each product type
        function updateIndication(val) {
            var output = "";
            var threshold = "";
            if (val == 'redcell') {
                threshold = @ViewBag.yHb[ViewBag.UHgb];
            }
            else if (val == 'platelet') {
                threshold = @ViewBag.yPlt[ViewBag.UPlt];
            }
            else if (val == 'ffp') {
                threshold = @ViewBag.yInr[ViewBag.UInr];
            }
            else if (val == 'cryoprecipitate') {
                threshold = @ViewBag.yFbg[ViewBag.UFbg];
            }
            else {
                threshold = 0;
            }
            var jsonObj = @Html.Raw(Json.Encode(ViewBag.Indications));
            for (var i in jsonObj) {
                if (jsonObj[i].Parameter == val) {
                    output += "<tr>"
                        + "<td><input type='radio' id=" + jsonObj[i].Id
                        + " name= '" + jsonObj[i].Parameter + "'"
                        + " value= '" + jsonObj[i].Caption + "'"
                        + " onchange = \"checkIndication(" + jsonObj[i].Level + "," + threshold + ",\'" + val + "\', '" + jsonObj[i].Caption +  "\')\">" + "</td >"
                        + "<td>" + jsonObj[i].Caption + "</td>"
                        + "</tr>";
                }
                else {
                    output += ""
                }
            }
            document.getElementById('list-indication-product').innerHTML = output;
            //Update field to state that a indication for the red cell transfusion has not been stated yet
            var indication = "Indication for <b>" + val + "</b> transfusion has not been provided yet"
            document.getElementById(val).innerHTML = indication;

            //Store indication for product as a session storage item and update to modal request form
            sessionStorage.setItem("indication_" + val, indication);
            displayIndication();
        }
    </script>

    <script>
        //Display short product or test info
        function productInfo(val) {
            var output = "";
            var header = "";
            var jsonObj = @Html.Raw(Json.Encode(ViewBag.ProductInfo));
            for (var i in jsonObj) {
                if (jsonObj[i].Id == val) {
                    if (jsonObj[i].Id.startsWith("T")) {
                        output += ""
                            + "<p>" + jsonObj[i].Comments + "</p>"
                            ;
                    }
                    else {
                        output += ""
                            + "<p><b>Contents:</b> " + jsonObj[i].Content + "</p>"
                            + "<p><b>Volume:</b> " + jsonObj[i].Volume + "</p>"
                            + "<p><b>Recommended dosage:</b> " + jsonObj[i].Dosage + "</p>"
                            + "<p><b>Additional requirements:</b> " + jsonObj[i].Comments + "</p>"
                            ;
                    }
                    header += ""
                        + jsonObj[i].Id
                        + " (" + jsonObj[i].Name + ")";
                }
                else {
                    output += "";
                    header += "";
                }
            }
            document.getElementById('list-info-product').innerHTML = output;
            document.getElementById('list-info-product-header').innerHTML = header;
        }
    </script>
    <script>
        //Validate radio-button for product indications
        function checkIndication(a, b, c, d) {
            var radios = document.getElementsByName(c);
            var fback;
            for (var i = 0; i < radios.length; i++) {
                if (c == 'redcell') {
                    if (b == 0) {
                        fback = "Red cell request has been made with no prior Hb results."
                    }
                    else if (b > 1.1 * a) {
                        fback = "You have chosen to transfuse at a target Hb of " + a + " but the patient's last Hb was " + b + " g/L."
                    }
                    else {
                        fback = ""
                    };
                }
                else if (c == 'platelet') {
                    if (b == 0) {
                        fback = "Platelet request has been made with no prior platelet count results."
                    }
                    else if (b > 1.1 * a) {
                        fback = "You have chosen to transfuse at a target platelet count of " + a + " but the patient's last count was " + b + " g/L."
                    }
                    else {
                        fback = ""
                    };
                }
                else if (c == 'ffp') {
                    if (b == 0) {
                        fback = "FFP request has been made with no prior INR results."
                    }
                    else if (b < 1.1 * a) {
                        fback = "You have chosen to transfuse at a target INR of " + a + " but the patient's last INR was " + b + "."
                    }
                    else {
                        fback = ""
                    };
                }
                else if (c == 'cryoprecipitate') {
                    if (b == 0) {
                        fback = "Cryoprecipitate request has been made with no prior fibrinogen results."
                    }
                    else if (b > 1.1 * a) {
                        fback = "You have chosen to transfuse at a target fibrinogen of " + a + " but the patient's last fibrinogen was " + b + ", " + @ViewBag.FbgInterval + " days ago."
                    }
                    else {
                        fback = ""
                    };
                }
                else {
                    fback = "";
                }
            }
            //Update indication and alerts for product on the request modal form
            //alert
            if (fback != "") {
                document.getElementById("alert_" + c + "").innerHTML = fback;
                sessionStorage.setItem("alert_" + c + "", fback);
            }
            //indication
            document.getElementById(c).innerHTML = "Indication (" + c + "): " + d;
            sessionStorage.setItem("indication_" + c, "Indication (" + c + "): " + d);

            displayIndication();
        }
    </script>
    <script>
        //Request validation on clicking Confirm Request in modal-request
        function confirmRequest() {
            var table = document.getElementById("tblConfirmRequest");
            var p;
            var indication;
            var nontest = 0; //counter for all products requested
            var count = 0; //counter for products where indication is not state
            var proc = 0; //counter for indications having a procedure
            var gs = 0; //counter for products that may require a GS
            var abd = 0; //counter for instances where only an ABD is required
            var warn = "";
            for (var i = 0, row; row = table.rows[i]; i++) {
                for (var j = 0, col; col = row.cells[j]; j++) {
                    if (j == 1) {
                        p = col.innerText;
                        //check if indication has been provided for the product. If none increment count
                        if (p != "test") {
                            nontest = nontest + 1;
                            let param = sessionStorage.getItem('indication_' + p + '');
                            indication = "Indication for <b>" + p + "</b> transfusion has not been provided yet"
                            if (param == indication) { count = count + 1; }
                            //if (param.includes('procedure')) { proc = proc + 1; }
                            //Check for any red cell request which may require a GS
                            if (p == 'redcell') {
                                if (@ViewBag.ReqValid == 0) { gs = gs + 1; }
                                else {
                                    if (@ViewBag.IssueIntNow > 2) { gs = gs + 1; }
                                    else { if (@ViewBag.Abonum == 1) { gs = gs + 1; } }
                                }
                            }
                            else if (p == 'platelet' || p == 'ffp' || p == 'cryoprecipitate' || p == 'cryosupernatant') {
                                if (@ViewBag.Abonum == 0) { gs = gs + 1; }
                                else if (@ViewBag.Abonum == 1) { abd = abd + 1; }
                            }
                        }
                    }
                }
            }

            var alerts = $('#warning-confirm-request');
            document.getElementById('warning-confirm-request').innerHTML = "";
            //Alert if indication not provided for any of the products
            if (count != 0) {
                warn = 'Please provide appropriate indication for each of the product requested.'
                alerts.append("<li class='list-group-item list-group-item-warning'>" + warn + "</li></span>");
            }

            //check for diagnosis
            if (document.getElementById('badge-disorder').innerText == "") {
                warn = 'Relevent clinical diagnosis must be provided.'
                alerts.append("<li class='list-group-item list-group-item-warning'>" + warn + "</li></span>");
            }

            //check for time required
            if (nontest != 0) {
                if (document.getElementById('badge-required-datetime').innerText == "") {
                    warn = 'Please state when the product is required.'
                    alerts.append("<li class='list-group-item list-group-item-warning'>" + warn + "</li></span>");
                }
            }

            //check for procedure if the product request is for pre-procedure
            /*
            if (document.getElementById('sct2-selected-values').html == "" && proc != 0) {
                warn = 'Please state the procedure for which this product is required.'
                alerts.append("<li class='list-group-item list-group-item-warning'>" + warn + "</li></span>");
            }
            */


            if (document.getElementById('badge-procedure').innerText == "?") {
                warn = 'Please state the procedure for which this product is required.'
                alerts.append("<li class='list-group-item list-group-item-warning'>" + warn + "</li></span>");
            }


            //Add GS if any red cells ordered or plasma products ordered without any previous ABD.
            if (gs != 0) {
                var i = 0;
                for (var item in cart) {
                    if (cart[item].id == "T-GSH") { i = i + 1; }
                    else if (cart[item].id == "T-ABD") { shoppingCart.removeItemFromCartAll("T-ABD"); }
                }
                if (i == 0) {
                    shoppingCart.addItemToCart("T-GSH", "Group Screen & Hold", 230, "test", 1);
                    displayCart(0);
                }
            }

            //Add ABD if any plasma products ordered with only a single ABD determination.
            if (abd != 0) {
                var i = 0;
                for (var item in cart) {
                    if (cart[item].id == "T-GSH" || cart[item].id == "T-ABD") { i = i + 1; }
                }
                if (i == 0) {
                    shoppingCart.addItemToCart("T-ABD", "ABO and RhD typing", 230, "test", 1);
                    displayCart(0);
                }
            }

            //confirm request if no alerts
            if (document.getElementById('warning-confirm-request').innerHTML == "") {
                warn = "Request cleared";
                alerts.append("<li class='list-group-item list-group-item-warning'>" + warn + "</li></span>");

                //Update request to Cart on clicking btnCartNew

            }
        }
    </script>
    <script>
        //Create New Cart on clicking btnCartNew
        $(document).ready(function () {
            $("#btnCartNew").click(function () {
                $.ajax(
                    {
                        type: "POST",
                        url: "/Patient/CartNew",
                        data: {
                            CartID: 11,
                            UserId: 1,
                            DateCreated: "13/01/2020 08:00",
                            CheckedOut: 0,
                            Urgency: 1,
                            Location: "6D",
                            PatientID: @Model.FirstOrDefault().PATNUMBER,
                            PatientName: "TEST PATIENT",
                            Status: 0
                        }
                    });
            });
        });
    </script>
    <script>
        //Add items to cart on clicking btnAddItems
        $(document).ready(function () {
            /*
            $("#btnAddItems").click(function () {

                var sessiondata = JSON.stringify(sessionStorage);
                document.getElementById('warning-confirm-request').innerHTML = sessiondata;

                $.ajax(
                    {
                        type: "POST",
                        url: "/Patient/ShoppingItem",
                        dataType: 'json',
                        contentType: 'application/json;charset=UTF-8',
                        data: sessiondata
                    });
                
                
            });
            */
            $("#btnAddItems").click(function () {
                //Loop through the product request table rows and build a JSON array.
                var cartItems = new Array();
                $("#tblConfirmRequest tbody tr").each(function () {
                    var row = $(this);
                    var cartItem = {};
                    cartItem.CartID = 1;
                    cartItem.ProductID = row.find("TD").eq(0).html();
                    cartItem.Price = row.find("TD").eq(3).html();
                    cartItem.Quantity = row.find("TD").eq(5).html();
                    cartItems.push(cartItem);
                });

                //Send the JSON array to Controller using AJAX.
                $.ajax({
                    type: "POST",
                    url: "/Patient/InsertCartItems",
                    data: JSON.stringify(cartItems),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (r) {
                        alert(r + " record(s) inserted.");
                    }
                });

            });


        });
    </script>
    <script>
        // ************************************************
        // Shopping Cart API
        // ************************************************

        var shoppingCart = (function () {
            // =============================
            // Private methods and propeties
            // =============================
            cart = [];

            // Constructor
            function Item(id, name, price, parameter, count) {
                this.id = id
                this.name = name;
                this.price = price;
                this.parameter = parameter;
                this.count = count;
            }

            // Save cart
            function saveCart() {
                sessionStorage.setItem('shoppingCart', JSON.stringify(cart));
            }

            // Load cart
            function loadCart() {
                cart = JSON.parse(sessionStorage.getItem('shoppingCart'));
            }
            if (sessionStorage.getItem("shoppingCart") != null) {
                loadCart();
            }


            // =============================
            // Public methods and propeties
            // =============================
            var obj = {};

            // Add to cart
            obj.addItemToCart = function (id, name, price, parameter, count) {
                for (var item in cart) {
                    if (cart[item].id === id) {
                        //increment max to 1 for tests
                        if (parameter == 'test') {
                            if (cart[item].count < 1) {
                                cart[item].count++;
                            }
                        }
                        //increment max to 6 for products
                        else {
                            if (cart[item].count < 6) {
                                cart[item].count++;
                            }
                        }
                        saveCart();
                        return;
                    }
                }
                var item = new Item(id, name, price, parameter, count);
                cart.push(item);
                saveCart();
            }
            // Set count from item
            obj.setCountForItem = function (id, count) {
                for (var i in cart) {
                    if (cart[i].id === id) {
                        cart[i].count = count;
                        break;
                    }
                }
            };
            // Remove item from cart
            obj.removeItemFromCart = function (id) {
                for (var item in cart) {
                    if (cart[item].id === id) {
                        if (cart[item].count > 1) {
                            cart[item].count--;
                            if (cart[item].count === 0) {
                                cart.splice(item, 1);
                            }
                        }
                        break;
                    }
                }
                saveCart();
            }

            // Remove all items from cart
            obj.removeItemFromCartAll = function (id) {
                for (var item in cart) {
                    if (cart[item].id === id) {
                        cart.splice(item, 1);
                        break;
                    }
                }
                saveCart();
            }

            // Clear cart
            obj.clearCart = function () {
                cart = [];
                saveCart();
            }

            // Count cart
            obj.totalCount = function () {
                var totalCount = 0;
                for (var item in cart) {
                    totalCount += cart[item].count;
                }
                return totalCount;
            }

            // Total cart
            obj.totalCart = function () {
                var totalCart = 0;
                for (var item in cart) {
                    totalCart += cart[item].price * cart[item].count;
                }
                return Number(totalCart.toFixed(2));
            }

            // List cart
            obj.listCart = function () {
                var cartCopy = [];
                for (i in cart) {
                    item = cart[i];
                    itemCopy = {};
                    for (p in item) {
                        itemCopy[p] = item[p];
                    }
                    itemCopy.total = Number(item.price * item.count).toFixed(2);
                    cartCopy.push(itemCopy)
                }
                return cartCopy;
            }

            // cart : Array
            // Item : Object/Class
            // addItemToCart : Function
            // removeItemFromCart : Function
            // removeItemFromCartAll : Function
            // clearCart : Function
            // countCart : Function
            // totalCart : Function
            // listCart : Function
            // saveCart : Function
            // loadCart : Function
            return obj;
        })();


        // *****************************************
        // Triggers / Events
        // *****************************************
        // Add item
        $('.add-to-cart').click(function (event) {
            event.preventDefault();
            var id = $(this).data('id');
            var name = $(this).data('name');
            var price = Number($(this).data('price'));
            var parameter = $(this).data('parameter');
            shoppingCart.addItemToCart(id, name, price, parameter, 1);
            displayCart();
        });

        // Clear items
        $('.clear-cart').click(function () {
            shoppingCart.clearCart();
            displayCart();
        });


        function displayCart(cfm) {
            var cartArray = shoppingCart.listCart();
            var output = "";
            document.getElementById("warning-confirm-request").innerHTML = "";
            for (var i in cartArray) {
                output += "<tr>"
                    + "<td>" + cartArray[i].id + "</td>"
                    + "<td style='display:none;'>" + cartArray[i].parameter + "</td>"
                    + "<td>" + cartArray[i].name + "</td>"
                    + "<td>" + cartArray[i].price + "</td>"
                    + "<td><div class='input-group input-group-sm col-xs-2 form-horizontal'><div class='btn-group'><button class='minus-item input-group-addon btn btn-outline-primary fa fa-minus' data-id=" + cartArray[i].id + " min='1' max='6'></button>"
                    + "<button class='plus-item btn btn-outline-secondary input-group-addon fa fa-plus' data-id=" + cartArray[i].id + " min='1' max='6'></button></div></div></td>"
                    + "<td>" + cartArray[i].count + "</td>"
                    + "<td><button class='delete-item btn btn-outline-danger fa fa-trash' data-id=" + cartArray[i].id + " data-parameter=" + cartArray[i].parameter + "></button></td>"
                    + " = "
                    + "<td>" + cartArray[i].total + "</td>"
                    + "</tr>";
            }
            $('.show-cart').html(output);
            $('.total-cart').html(shoppingCart.totalCart());
            $('.total-count').html(shoppingCart.totalCount());

            displayIndication();
            if (cfm == 0) {
                confirmRequest();
            }
        }

        //Update alerts and indication  notice
        function displayIndication() {

            //Update alert of modal request form and all other alerts and indication
            var productIndication = $('#modal-alert');
            document.getElementById('modal-alert').innerHTML = "";
            var cProcedure = 0;

            for (let i = 0; i < sessionStorage.length; i++) {
                let key = sessionStorage.key(i);
                let value = sessionStorage.getItem(key);
                if (key.startsWith('indication_') && !(value == "")) {
                    productIndication.append("<li class='list-group-item list-group-item-primary'>" + value + "</li></span>");
                    if (value.includes('procedure')) {
                        cProcedure = cProcedure + 1;
                    }
                }
            }
            for (let i = 0; i < sessionStorage.length; i++) {
                let key = sessionStorage.key(i);
                let value = sessionStorage.getItem(key);
                if (key.startsWith('alert_') && !(value == "")) {
                    productIndication.append("<li class='list-group-item list-group-item-danger'>" + value + "</li></span>");
                }
            }
            alertProcedure(cProcedure);
        }

        //Add or clear for badge-procedure on update indication
        function alertProcedure(i) {
            var procedureBadge = document.getElementById('badge-procedure').innerHTML;
            if (i != 0) {
                if (procedureBadge == '') {
                    document.getElementById('badge-procedure').innerHTML = '?';
                }
            }
            else {
                if (procedureBadge == '?') {
                    document.getElementById('badge-procedure').innerHTML = '';
                }
            }
        }

        // Delete item button

        $('.show-cart').on("click", ".delete-item", function (event) {
            var id = $(this).data('id')
            var parameter = $(this).data('parameter')

            shoppingCart.removeItemFromCartAll(id);

            //Remove alerts and indication if there are no products ordered for that type after deletion of item
            var cartArray = shoppingCart.listCart();
            var count = 0;
            var countp = 0;

            for (let i = 0; i < sessionStorage.length; i++) {
                let key = sessionStorage.key(i);
                let value = sessionStorage.getItem(key);
                if (key == 'shoppingCart') {
                    if (value.includes(parameter)) {
                        count = count + 1
                    }
                }
                if (key.startsWith('indication_') && !(value == "")) {
                    if (value.includes('procedure')) {
                        countp = countp + 1;
                    }
                }
            }

            if (count == 0) {
                sessionStorage.removeItem('alert_' + parameter + '');
                sessionStorage.removeItem('indication_' + parameter + '');
                document.getElementById('alert_' + parameter + '').innerHTML = '';
                document.getElementById('' + parameter + '').innerHTML = '';
            }

            //alertProcedure(countp);
            displayCart();
        })


        // -1
        $('.show-cart').on("click", ".minus-item", function (event) {
            var id = $(this).data('id')
            shoppingCart.removeItemFromCart(id);
            displayCart();
        })
        // +1
        $('.show-cart').on("click", ".plus-item", function (event) {
            var id = $(this).data('id')
            shoppingCart.addItemToCart(id);
            displayCart();
        })

        // Item count input
        $('.show-cart').on("change", ".item-count", function (event) {
            var id = $(this).data('id');
            var count = Number($(this).val());
            shoppingCart.setCountForItem(id, count);
            displayCart();
        });

        displayCart();
    </script>


</body>
</html>



